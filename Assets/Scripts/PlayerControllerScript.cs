using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class PlayerControllerScript : MonoBehaviour
{
    private float _horizontalInput = default;
    private float _verticalInput = default;

    private GameObject _playerMino = default;

    public GameObject PlayerMino { get => _playerMino; set => _playerMino = value; }

    [SerializeField, Header("入力時のクールタイム")]
    private float _inputCoolTime = 0.1f;

    private float _inputTime = default;

    private float _fallTime = default;

    [SerializeField,Header("ミノが落ちる時間")]
    private float _fallCoolTime = 1f;

    // ミノが床にふれてからの時間
    private float _minoFloorTime = default;

    private float _minMinoLifeTime = 1.1f;
    private float _maxMinoLifeTime = 3f;

    // ミノの生存時間
    private float _minoLifeTime = 0.5f;

    private float _defaultMinoLifeTime = default;

    private float _addDeathTime = 0.5f;

    private Transform _beforeTransform = default;

    private FieldDataScript _fieldDataScript = default;

    private float _beforeTime = default;

    private float _beforeCoolTime = 0.3f;

    private MinoControllerScript _minoControllerScript = default;
    
    private void Start()
    {
        _fieldDataScript = GameObject.Find("Stage").GetComponent<FieldDataScript>();
        
        _defaultMinoLifeTime = _minoLifeTime;

        _minoControllerScript = GameObject.Find("MinoController").GetComponent<MinoControllerScript>();
    }

    public void PlayerController(
        GameControllerScript.MinoEraseChangeMethod _minoEraseMethod,GameControllerScript.MinoCreateMethod _minoCreateMethod)
    {
        _horizontalInput = Input.GetAxisRaw("Horizontal");
        _verticalInput = Input.GetAxisRaw("Vertical");    
        
        // 右入力されたとき
        if (_horizontalInput > 0 && (Time.time - _inputTime) > _inputCoolTime)
        {
            PlayerMino.transform.Translate(1f, 0f, 0f,Space.World);

            _inputTime = Time.time;

            if (BeforeMoving())
            {
                PlayerMino.transform.Translate(-1f, 0f, 0f, Space.World);
            }
        }
        // 左入力されたとき
        else if (_horizontalInput < 0 && (Time.time - _inputTime) > _inputCoolTime)
        {
            PlayerMino.transform.Translate(-1f, 0f, 0f,Space.World);

            _inputTime = Time.time;

            if (BeforeMoving())
            {
                PlayerMino.transform.Translate(1f, 0f, 0f, Space.World);
            }
        }
        // 上入力されたとき
        if (Input.GetKeyDown(KeyCode.W) || Input.GetKeyDown(KeyCode.UpArrow))
        {
            while (!BeforeMoving())
            {
                PlayerMino.transform.Translate(0f, -1f, 0f, Space.World);
            }
            PlayerMino.transform.Translate(0f, 1f, 0f, Space.World);

            AddMinoToField();         

            CutParentMino();
            _minoEraseMethod();
        }
        // 下入力されたとき
        else if (_verticalInput < 0 && (Time.time - _inputTime) > _inputCoolTime)
        {
            PlayerMino.transform.Translate(0f, -1f, 0f,Space.World);

            _inputTime = Time.time;

            if (BeforeMoving())
            {
                PlayerMino.transform.Translate(0f, 1f, 0f, Space.World);

                AddMinoToField();
                
                CutParentMino();
                _minoEraseMethod();               
            }
        }

        if ((Time.time - _fallTime) > _fallCoolTime)
        {          
            PlayerMino.transform.Translate(0f, -1f, 0f,Space.World);

            _fallTime = Time.time;

            if (BeforeMoving())
            {
                PlayerMino.transform.Translate(0f, 1f, 0f, Space.World);

                AddMinoToField();
                
                CutParentMino();
                _minoEraseMethod();            
            }
        }

        if (Input.GetKeyDown(KeyCode.Q))
        {
            // 右回転
            PlayerMino.transform.Rotate(0f, 0f, 90f, Space.World);

            if ( BeforeMoving())
            {
                PlayerMino.transform.Rotate(0f, 0f, -90f, Space.World);              
            }
        }
        else if (Input.GetKeyDown(KeyCode.E))
        {
            // 左回転
            PlayerMino.transform.Rotate(0f, 0f, -90f, Space.World);

            if (BeforeMoving())
            {
                PlayerMino.transform.Rotate(0f, 0f, 90f, Space.World);              
            }
        }

        // ホールド
        if (Input.GetKeyDown(KeyCode.LeftShift))
        {
            _minoControllerScript.HoldController(PlayerMino,_minoCreateMethod);          
        }

     
        //if (-17.5f >= PlayerMino.transform.position.y)
        //{
        //    _minoFloorTime += Time.deltaTime;

        //    //// ミノが動いていたら
        //    //if (_playerMino.transform != _beforeTransform)
        //    //{
        //    //    Debug.LogError("呼ばれた");
        //    //    // ミノの生存時間を増やす
        //    //    _minoLifeTime += _addDeathTime;
        //    //}
        //    //if ((Time.time - _beforeTime) > _beforeCoolTime)
        //    //{

        //    //    _beforeTransform.position = _playerMino.transform.position;
        //    //    _beforeTime = Time.time;
        //    //}
        //    _minoLifeTime = Mathf.Clamp(_minoLifeTime, _minMinoLifeTime, _maxMinoLifeTime);
        //}

        //if (_minoFloorTime > _minoLifeTime)
        //{
        //    //foreach(Transform t in _playerMino.GetComponentInChildren<Transform>())
        //    //{
        //    //    _fieldDataScript.FieldData[(int)t.position.x,(int)t.position.y] = 2;
        //    //}

        //    // ミノの生存時間リセット
        //    _minoLifeTime = _defaultMinoLifeTime;

        //    // タイマーリセット
        //    _minoFloorTime = 0;

        //    // 次のミノを生成する処理に切り替える
        //    _gameTypeChangeMethod();
        //}

    }

    private bool BeforeMoving()
    {
        foreach(Transform _children in PlayerMino.GetComponentInChildren<Transform>())
        {
            Debug.Log("X "+_children.transform.position.x +" Y "+ _children.transform.position.y);
            
            int _posX = Mathf.RoundToInt(_children.transform.position.x);
            int _posY = Mathf.RoundToInt(_children.transform.position.y);

            Debug.Log(_posX + "" + _posY);
            // ミノがステージの範囲外だったら
            if (_posX <= -1 || 10 <= _posX || _posY <= -20)
            {
                return true;
            }

            if (_posY <= 0 && _fieldDataScript.FieldData[-_posY,_posX] != null)
            {
                return true;
            }
        }
        return false;
    }

    private int FloorLocation()
    {
        int _leastPosY = default;
        foreach (Transform _children in PlayerMino.GetComponentInChildren<Transform>())
        {
            int _playerPosY = Mathf.RoundToInt(PlayerMino.transform.position.y);
            int _posX = Mathf.RoundToInt(_children.transform.position.x);
            int _posY = Mathf.RoundToInt(_children.transform.position.y);
            

            for (int i = _posY;i > -20;i--)
            {
                if (_fieldDataScript.FieldData[-i, _posX] != null && _leastPosY < (i + 1) - (_playerPosY - _posY))
                {
                    _leastPosY = (i + 1) - (_playerPosY - _posY);
                }                              
            }

            //if (_leastPosY == 0)
            //{
            //    _leastPosY = -_fieldDataScript.Height + (_posY - (_playerPosY - _posY));
            //}          
        }
       
        return _leastPosY;
    }

    //private void PutInside()
    //{
    //    foreach (Transform _children in PlayerMino.GetComponentInChildren<Transform>())
    //    {
    //        int _posX = Mathf.RoundToInt(_children.transform.position.x);
    //        int _posY = Mathf.RoundToInt(_children.transform.position.y);

    //        // ミノがステージの範囲外だったら
    //        if ( _posX <= -1)
    //        {
    //            PlayerMino.transform.Translate(1f, 0f, 0f, Space.World);
    //        }
    //        else if ( 10 <= _posX)
    //        {
    //            PlayerMino.transform.Translate(-1f, 0f, 0f, Space.World);
    //        }
    //        if(_posY <= -20)
    //        {
    //            PlayerMino.transform.Translate(0f, 1f, 0f, Space.World);
    //        }

    //    }
    //}

    /// <summary>
    /// フィールドデータに置いたミノを反映させる処理
    /// </summary>
    private void AddMinoToField()
    {
        foreach (Transform _children in PlayerMino.GetComponentInChildren<Transform>())
        {
            int _posX = Mathf.RoundToInt(_children.transform.position.x);
            int _posY = Mathf.RoundToInt(_children.transform.position.y);

            // フィールドに置いたミノを反映させる
            _fieldDataScript.FieldData[-_posY, _posX] = _children.gameObject;
        }
    }
    /// <summary>
    /// ミノの親オブジェクト（回転軸）を消す処理
    /// </summary>
    private void CutParentMino()
    {
        PlayerMino.transform.DetachChildren();
        Destroy(PlayerMino);
    }
}
